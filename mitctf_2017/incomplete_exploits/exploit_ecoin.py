#!/usr/bin/env python
import json
import re
import requests

r = requests.get('http://ecoin.mitctf.com:9999/')

block_re = re.compile("<textarea class='block'>([^<]*)</textarea>")

blocks = list(map(json.loads, block_re.findall(r.text)))

with open('blocks.json', 'w') as f:
    f.write(json.dumps(blocks))

for i, b in enumerate(blocks):
    print("Block %d's message is %r" % (i, b['data']['message']))

seen_keys = [dict(), dict()]
seen_sigs = dict()

for i, b in enumerate(blocks):
    for keys in b['signature']['block_pubkey']:
        for bit in [0,1]:
            key = keys[bit]
            seen_keys[bit][key] = seen_keys[bit].get(key, 0) + 1
            if seen_keys[bit][key] > 1:
                print('Found a duplicate pubkey in block %d' % (i,))
    for sig in b['signature']['block_signature']:
        seen_sigs[sig] = seen_sigs.get(sig, 0) + 1
        if seen_sigs[sig] > 1:
            print('Found a duplicate signature in block %d' % (i,))
